# ============================================
# True Love Server - Docker Compose (Win11 + SMB)
# ============================================
#
# 部署在 Win11 Docker Desktop (WSL2)，通过 SMB 共享挂载文件
#
# 前置准备：
#   1. 在 Win11 上启用文件共享：
#      - 右键 C:\Users\admin\Desktop\true-love-n 文件夹
#      - 选择"属性" -> "共享" -> "高级共享"
#      - 勾选"共享此文件夹"，共享名设置为 "true-love-n"
#      - 点击"权限"，确保用户 admin 有完全控制权限
#   
#   2. 确保 Windows 防火墙允许文件共享（SMB 端口 445）
#
# 使用方式：
#   cd C:\Users\admin\Desktop\true-love-n\true-love-server
#   docker compose pull      # 拉取最新镜像
#   docker compose up -d     # 启动/更新容器
#   docker compose logs -f   # 查看日志
#   docker compose ps        # 查看状态
#   docker compose down      # 停止并删除容器
#
# ============================================

services:
  true-love-server:
    # 镜像地址
    image: ghcr.io/oreoft/true-love-server:latest
    
    # 容器名称
    container_name: tl-server
    
    # 重启策略
    restart: unless-stopped

    # 端口映射（Docker Desktop WSL2 模式下 host 网络无效）
    ports:
      - "8088:8088"

    # 添加 host.docker.internal 解析（用于容器内访问 Windows 服务）
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # 卷挂载 - 只挂载 SMB 卷，通过软链接访问文件
    volumes:
      - type: volume
        source: true-love-smb
        target: /mnt/true-love-n
        volume:
          nocopy: true

    # 启动前创建软链接，将 SMB 挂载点的文件链接到 /app 目录
    command: >
      /bin/sh -c "
      sleep 2 &&
      ln -sf /mnt/true-love-n/true-love-server/config.yaml /app/config.yaml &&
      ln -sf /mnt/true-love-n/true-love-base/listen_chats.json /app/listen_chats.json &&
      ln -sf /mnt/true-love-n/true-love-server/dbs /app/dbs &&
      ln -sf /mnt/true-love-n/true-love-base/wx_imgs /app/wx_imgs &&
      ln -sf /mnt/true-love-n/true-love-base/moyu-jpg /app/moyu-jpg &&
      ln -sf /mnt/true-love-n/true-love-base/zaobao-jpg /app/zaobao-jpg &&
      ln -sf /mnt/true-love-n/true-love-base/gen-img /app/gen-img &&
      exec python -m true_love_server
      "

    # 环境变量
    environment:
      - APP_ENV=prod
      - TZ=Asia/Shanghai
    
    # 健康检查
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8088/health" ]
      interval: 30s      # 检查间隔
      timeout: 10s       # 超时时间
      retries: 3         # 失败重试次数
      start_period: 10s  # 启动等待时间

# SMB 卷定义（使用预先创建的外部卷）
# 创建命令：docker volume create --driver local --opt type=cifs --opt device="//host.docker.internal/true-love-n" --opt "o=username=admin,password=YOUR_PASSWORD,uid=0,gid=0,file_mode=0777,dir_mode=0777,vers=3.0" true-love-server_true-love-smb
volumes:
  true-love-smb:
    external: true
    name: true-love-server_true-love-smb
