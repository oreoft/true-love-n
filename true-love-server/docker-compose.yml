# ============================================
# True Love Server - Docker Compose (Win11 + SMB)
# ============================================
#
# 部署在 Win11 Docker Desktop (WSL2)，通过 SMB 共享挂载文件
#
# 前置准备：
#   1. 在 Win11 上启用文件共享：
#      - 右键 C:\Users\admin\Desktop\true-love-n 文件夹
#      - 选择"属性" -> "共享" -> "高级共享"
#      - 勾选"共享此文件夹"，共享名设置为 "true-love-n"
#      - 点击"权限"，确保用户 admin 有完全控制权限
#   
#   2. 确保 Windows 防火墙允许文件共享（SMB 端口 445）
#
# 使用方式：
#   cd C:\Users\admin\Desktop\true-love-n\true-love-server
#   docker compose pull      # 拉取最新镜像
#   docker compose up -d     # 启动/更新容器
#   docker compose logs -f   # 查看日志
#   docker compose ps        # 查看状态
#   docker compose down      # 停止并删除容器
#
# ============================================

services:
  true-love-server:
    # 镜像地址
    image: ghcr.io/oreoft/true-love-server:latest
    
    # 容器名称
    container_name: tl-server
    
    # 重启策略
    restart: unless-stopped

    network_mode: "host"

    # 卷挂载
    # 通过 SMB 共享挂载 Win11 文件系统，避免 WSL2 文件系统性能问题
    volumes:
      # SMB 根目录挂载
      - type: volume
        source: true-love-smb
        target: /mnt/true-love-n
        volume:
          nocopy: true
      
      # 配置文件（只读挂载）
      - /mnt/true-love-n/true-love-server/config.yaml:/app/config.yaml:ro
      
      # 监听配置（与 base 共享）
      - /mnt/true-love-n/true-love-base/listen_chats.json:/app/listen_chats.json
      
      # 数据库目录（持久化所有 .db 文件）
      - /mnt/true-love-n/true-love-server/dbs:/app/dbs
      
      # 微信图片目录（与 base 共享）
      - /mnt/true-love-n/true-love-base/wx_imgs:/app/wx_imgs
      
      # 摸鱼图片目录（与 base 共享）
      - /mnt/true-love-n/true-love-base/moyu-jpg:/app/moyu-jpg
      
      # 早报图片目录（与 base 共享）
      - /mnt/true-love-n/true-love-base/zaobao-jpg:/app/zaobao-jpg

      # 生成图片
      - /mnt/true-love-n/true-love-base/gen-img:/app/gen-img

    # 环境变量
    environment:
      - APP_ENV=prod
      - TZ=Asia/Shanghai
    
    # 健康检查
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8088/health" ]
      interval: 30s      # 检查间隔
      timeout: 10s       # 超时时间
      retries: 3         # 失败重试次数
      start_period: 10s  # 启动等待时间

# SMB 卷定义
volumes:
  true-love-smb:
    driver: local
    driver_opts:
      type: cifs
      # host.docker.internal 在 Docker Desktop 中指向宿主机
      # 也可以用 Win11 的实际 IP 地址替换
      device: "//host.docker.internal/true-love-n"
      o: "username=admin,password=${SMB_PASSWORD:-},uid=0,gid=0,file_mode=0777,dir_mode=0777,vers=3.0"
