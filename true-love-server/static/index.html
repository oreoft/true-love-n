<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœŸçˆ±ç²‰ç®¡ç†</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app">
        <!-- Toast Container -->
        <div class="toast-container">
            <div 
                v-for="toast in toasts" 
                :key="toast.id" 
                :class="['toast', toast.type]"
            >
                {{ toast.message }}
            </div>
        </div>
        
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1>ğŸ“¡ <span>çœŸçˆ±ç²‰</span>ç®¡ç†</h1>
                <div class="header-actions">
                    <button 
                        :class="['btn', 'btn-sm', activeTab === 'list' ? 'btn-primary' : 'btn-outline-light']"
                        @click="switchTab('list')"
                    >
                        ğŸ“‹ åˆ—è¡¨
                    </button>
                    <button 
                        :class="['btn', 'btn-sm', activeTab === 'logs' ? 'btn-primary' : 'btn-outline-light']"
                        @click="switchTab('logs')"
                    >
                        ğŸ“ æ—¥å¿—
                    </button>
                </div>
            </div>
        </header>
        
        <!-- List Page -->
        <template v-if="activeTab === 'list'">
            <!-- Summary Bar -->
            <div class="summary-bar">
                <div class="summary-content">
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-dot healthy"></span>
                            <span class="stat-label">å¥åº·</span>
                            <span class="stat-value">{{ summary.healthy }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-dot unhealthy"></span>
                            <span class="stat-label">å¼‚å¸¸</span>
                            <span class="stat-value">{{ summary.unhealthy }}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-outline btn-sm" @click="refreshAll" :disabled="loading">
                            {{ loading ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°' }}
                        </button>
                        <button class="btn btn-secondary btn-sm" @click="resetAll" :disabled="loading">
                            é‡ç½®
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- List -->
            <div class="list-container">
                <div class="list-header">
                    <span class="list-title">ç›‘å¬åˆ—è¡¨ ({{ listeners.length }})</span>
                </div>
                
                <!-- Loading -->
                <div v-if="loading && listeners.length === 0" class="loading">
                    <div class="spinner"></div>
                    <p>åŠ è½½ä¸­...</p>
                </div>
                
                <!-- List Content -->
                <div v-else class="listener-list">
                    <!-- Listener Items -->
                    <div 
                        v-for="item in listeners" 
                        :key="item.chat" 
                        class="listener-item"
                    >
                        <div class="listener-info">
                            <span :class="['status-indicator', item.status]"></span>
                            <div class="listener-details">
                                <div class="listener-name">{{ item.chat }}</div>
                                <div :class="['listener-status', item.status]">
                                    {{ item.status === 'healthy' ? 'è¿è¡Œæ­£å¸¸' : (item.reason || 'çŠ¶æ€å¼‚å¸¸') }}
                                </div>
                            </div>
                        </div>
                        <div class="listener-actions">
                            <button 
                                class="btn btn-secondary btn-sm" 
                                @click="testAlive(item.chat)"
                                :disabled="loadingItems[item.chat]"
                            >
                                {{ loadingItems[item.chat] === 'test' ? 'æµ‹è¯•ä¸­...' : 'æµ‹æ´»' }}
                            </button>
                            <button 
                                class="btn btn-outline btn-sm" 
                                @click="resetOne(item.chat)"
                                :disabled="loadingItems[item.chat]"
                            >
                                {{ loadingItems[item.chat] === 'reset' ? 'é‡ç½®ä¸­...' : 'é‡ç½®' }}
                            </button>
                            <button 
                                class="btn btn-danger btn-sm" 
                                @click="removeOne(item.chat)"
                                :disabled="loadingItems[item.chat]"
                            >
                                {{ loadingItems[item.chat] === 'remove' ? 'åˆ é™¤ä¸­...' : 'åˆ é™¤' }}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Add Card -->
                    <div class="add-card" @click="showAddModal = true">
                        <span>â•</span>
                        <span>æ·»åŠ ç›‘å¬</span>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div v-if="!loading && listeners.length === 0" class="empty-state">
                    <div class="empty-icon">ğŸ“­</div>
                    <p class="empty-text">æš‚æ— ç›‘å¬è®°å½•</p>
                </div>
            </div>
        </template>
        
        <!-- Logs Page (Loki) -->
        <template v-else-if="activeTab === 'logs'">
            <div class="loki-logs-container">
                <div class="loki-logs-header">
                    <div class="logs-controls">
                        <!-- æœåŠ¡è¿‡æ»¤ -->
                        <div class="service-filter-tags">
                            <span 
                                v-for="svc in lokiServices" 
                                :key="svc"
                                :class="['service-filter-tag', { active: lokiServiceFilter.includes(svc) }]"
                                @click="toggleServiceFilter(svc)"
                            >
                                {{ svc }}
                            </span>
                        </div>
                        
                        <button class="btn btn-outline btn-xs" @click="refreshLokiLogs" :disabled="lokiLoading" title="åˆ·æ–°">
                            {{ lokiLoading ? 'åŠ è½½ä¸­...' : 'ğŸ”„ åˆ·æ–°' }}
                        </button>
                        <button class="btn btn-outline btn-xs" @click="clearLokiLogs" title="æ¸…ç©ºæ˜¾ç¤º">
                            æ¸…ç©º
                        </button>
                    </div>
                    <div class="loki-logs-info">
                        <span>
                            <span :class="['poll-indicator', { paused: !lokiPolling }]"></span>
                            {{ lokiPolling ? 'è½®è¯¢ä¸­' : 'å·²æš‚åœ' }}
                        </span>
                        <span>{{ filteredLokiLogs.length }} æ¡</span>
                        <span v-if="lokiTimeRange" class="time-range-display">
                            {{ lokiTimeRange }}
                        </span>
                    </div>
                </div>
                
                <div class="loki-logs-content" ref="lokiLogsContainer" @scroll="handleLokiScroll">
                    <!-- åŠ è½½æ›´æ—©æ—¥å¿—çš„æç¤º -->
                    <div v-if="lokiCanLoadOlder" class="load-more-hint" :class="{ loading: lokiLoadingOlder }">
                        {{ lokiLoadingOlder ? 'åŠ è½½ä¸­...' : 'â†‘ æ»šåŠ¨åˆ°é¡¶éƒ¨åŠ è½½æ›´æ—©æ—¥å¿—' }}
                    </div>
                    
                    <template v-if="filteredLokiLogs.length > 0">
                        <div 
                            v-for="log in filteredLokiLogs" 
                            :key="log.timestamp + log.raw"
                            :class="['loki-log-item', { 'error-row': log.level === 'ERROR', 'warn-row': log.level === 'WARN' }]"
                        >
                            <span class="loki-log-dots">â‹®</span>
                            <span class="loki-log-time">{{ log.time_str }}</span>
                            <span :class="['loki-log-level', log.level]">{{ log.level }}</span>
                            <span class="loki-log-service">{{ log.service }}</span>
                            <span class="loki-log-separator">|</span>
                            <span class="loki-log-content">{{ log.content }}</span>
                        </div>
                    </template>
                    
                    <div v-else class="loki-logs-empty">
                        <div class="loki-logs-empty-icon">ğŸ“œ</div>
                        <p>{{ lokiLoading ? 'åŠ è½½ä¸­...' : 'æš‚æ— æ—¥å¿—' }}</p>
                    </div>
                    
                    <!-- åŠ è½½æœ€æ–°æ—¥å¿—çš„æç¤º -->
                    <div v-if="lokiLogs.length > 0 && !lokiLoading" class="load-more-hint" :class="{ loading: lokiLoadingNewer }">
                        {{ lokiLoadingNewer ? 'åŠ è½½ä¸­...' : 'â†“ æ»šåŠ¨åˆ°åº•éƒ¨åŠ è½½æœ€æ–°æ—¥å¿—' }}
                    </div>
                </div>
                
                <!-- æ»šåŠ¨æŒ‰é’® -->
                <div class="scroll-btns">
                    <button 
                        class="scroll-btn"
                        @click="scrollToTop"
                        title="æ»šåŠ¨åˆ°é¡¶éƒ¨"
                    >
                        â¬†ï¸
                    </button>
                    <button 
                        :class="['scroll-btn', { active: lokiAutoScroll }]"
                        @click="toggleLokiAutoScroll"
                        :title="lokiAutoScroll ? 'è‡ªåŠ¨æ»šåŠ¨å¼€å¯' : 'è‡ªåŠ¨æ»šåŠ¨å…³é—­'"
                    >
                        â¬‡ï¸
                    </button>
                </div>
            </div>
        </template>
        
        <!-- Add Modal -->
        <div v-if="showAddModal" class="modal-overlay" @click.self="showAddModal = false">
            <div class="modal">
                <h3 class="modal-title">æ·»åŠ ç›‘å¬</h3>
                <input 
                    v-model="newChatName" 
                    class="modal-input" 
                    placeholder="è¯·è¾“å…¥èŠå¤©åç§°ï¼ˆå¥½å‹æ˜µç§°æˆ–ç¾¤åï¼‰"
                    @keyup.enter="addListener"
                    ref="addInput"
                />
                <div class="modal-actions">
                    <button class="btn btn-outline" @click="showAddModal = false">å–æ¶ˆ</button>
                    <button class="btn btn-primary" @click="addListener" :disabled="!newChatName.trim() || addLoading">
                        {{ addLoading ? 'æ·»åŠ ä¸­...' : 'ç¡®è®¤æ·»åŠ ' }}
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Confirm Modal -->
        <div v-if="confirmModal.show" class="modal-overlay" @click.self="confirmModal.show = false">
            <div class="modal">
                <h3 class="modal-title">{{ confirmModal.title }}</h3>
                <p class="modal-message">{{ confirmModal.message }}</p>
                <div class="modal-actions">
                    <button class="btn btn-outline" @click="confirmModal.show = false">å–æ¶ˆ</button>
                    <button class="btn btn-danger" @click="confirmModal.onConfirm">ç¡®è®¤</button>
                </div>
            </div>
        </div>
        
        <!-- Test Alive Result Modal -->
        <div v-if="testAliveModal.show" class="modal-overlay" @click.self="testAliveModal.show = false">
            <div class="modal modal-lg modal-tall">
                <button class="modal-close-btn" @click="testAliveModal.show = false">Ã—</button>
                <h3 class="modal-title">ğŸ” æµ‹æ´»ç»“æœ - {{ testAliveModal.chatName }}</h3>
                <div class="test-result-content">
                    <div v-if="testAliveModal.loading" class="test-loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨æµ‹è¯•...</p>
                    </div>
                    <div v-else-if="testAliveModal.error" class="test-error">
                        <p>âŒ {{ testAliveModal.error }}</p>
                    </div>
                    <div v-else class="test-success">
                        <div class="test-status" :class="testAliveModal.result?.success ? 'success' : 'fail'">
                            <span>{{ testAliveModal.result?.success ? 'âœ… è¿æ¥æ­£å¸¸' : 'âŒ è¿æ¥å¼‚å¸¸' }}</span>
                        </div>
                        <div v-if="testAliveModal.result?.message" class="test-message">
                            <strong>æ¶ˆæ¯ï¼š</strong>{{ testAliveModal.result.message }}
                        </div>
                        <div v-if="testAliveModal.result?.data" class="test-data">
                            <strong>è¿”å›æ•°æ®ï¼š</strong>
                            <pre>{{ JSON.stringify(testAliveModal.result.data, null, 2) }}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/static/js/app.js"></script>
</body>
</html>

