name: true-love-server Deploy to m8s-wsl via SSH

on:
  push:
    branches: [ "master" ]
    paths:
      - "true-love-server/**"
      - ".github/workflows/true-love-server.yml"

env:
  SERVER_IP: ${{ secrets.M8S_PROXY_HOST }}
  SERVER_PORT: 2233
  SERVER_USER: admin
  SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH and Run Commands
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ env.SERVER_SSH_KEY }}

      - name: Execute ai Commands Over SSH
        shell: bash
        run: |
          set -euo pipefail
          echo "SSH env ready"
          # 目标机是 Win11，SSH 进去默认是 PowerShell/CMD；应用在 WSL 里。
          # 用 wsl.exe 启动 WSL 的 bash，并通过 STDIN 喂入脚本，避免引号/$HOME/$PATH 在 PowerShell 中被展开。
          ssh -o StrictHostKeyChecking=no -p "${{ env.SERVER_PORT }}" "${{ env.SERVER_USER }}@${{ env.SERVER_IP }}" "wsl.exe -u root -e bash -s" <<'EOS'
          set -euo pipefail

          cd /root/true-love-n/true-love-server

          # 确保 PATH 立刻可用（不要依赖 ~/.bashrc 在非交互 shell 自动加载）
          export PATH="$HOME/.local/bin:$PATH"

          # 保证 uv 安装（注意：如果 uv 已装但 PATH 没包含 ~/.local/bin，会被误判为 not found）
          if ! command -v uv >/dev/null 2>&1; then
            echo "uv not found, installing..."
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="$HOME/.local/bin:$PATH"
          else
            echo "uv already installed."
          fi

          git pull

          # 同步
          uv sync --locked

          # 重启（要求 WSL 内 systemd 已启用）
          systemctl restart app-tl-server
          EOS

      - name: Notify - ai Success
        if: success()
        run: |
          curl --location ${{ secrets.TURE_LOVE_URL_PATH }} \
          --header 'Content-Type: application/json' \
          --data '{
            "token": "${{ secrets.TURE_LOVE_TOKEN }}",
            "sendReceiver": "master",
            "atReceiver": "",
            "content": "真爱粉ai模块已经成功重启"
          }' || echo "通知发送失败，但部署成功"
